\begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
\PY{c+c1}{// "data" is passed from userspace.}
\PY{k}{struct} \PY{n}{drm\PYZus{}vmw\PYZus{}update\PYZus{}layout\PYZus{}arg} \PY{o}{*}\PY{n}{arg} \PY{o}{=} \PY{n}{data}\PY{p}{;}
\PY{k}{struct} \PY{n}{drm\PYZus{}vmw\PYZus{}rect} \PY{o}{*}\PY{n}{rects} \PY{o}{=} \PY{l+m+mi}{0}\PY{p}{;}
\PY{k+kt}{unsigned} \PY{n}{size}\PY{p}{;}
\PY{k+kt}{int} \PY{n}{i}\PY{p}{,} \PY{n}{ret} \PY{o}{=} \PY{l+m+mi}{0}\PY{p}{;}
\PY{c+c1}{// Check arg->num\PYZus{}outputs.}
\PY{k}{if} \PY{p}{(}\PY{o}{!}\PY{n}{arg}\PY{o}{-}\PY{o}{>}\PY{n}{num\PYZus{}outputs}\PY{p}{)}
	\PY{k}{goto} \PY{n}{out}\PY{p}{;}
\PY{c+c1}{// Compute allocation size for "rects".}
\PY{c+c1}{// sizeof(struct drm\PYZus{}vmw\PYZus{}rect) = 16.}
\PY{n}{size} \PY{o}{=} \PY{n}{arg}\PY{o}{-}\PY{o}{>}\PY{n}{num\PYZus{}outputs} \PY{o}{*} \PY{k}{sizeof}\PY{p}{(}\PY{k}{struct} \PY{n}{drm\PYZus{}vmw\PYZus{}rect}\PY{p}{)}\PY{p}{;}
\PY{c+c1}{// Allocate memory.}
\PY{n}{rects} \PY{o}{=} \PY{n}{kzalloc}\PY{p}{(}\PY{n}{size}\PY{p}{,} \PY{n}{GFP\PYZus{}KERNEL}\PY{p}{)}\PY{p}{;}
\PY{k}{if} \PY{p}{(}\PY{n}{unlikely}\PY{p}{(}\PY{o}{!}\PY{n}{rects}\PY{p}{)}\PY{p}{)} \PY{p}{\PYZob{}}
	\PY{n}{ret} \PY{o}{=} \PY{o}{-}\PY{n}{ENOMEM}\PY{p}{;}
	\PY{k}{goto} \PY{n}{out}\PY{p}{;}
\PY{p}{\PYZcb{}}
\PY{c+c1}{// Validate input data.}
\PY{k}{for} \PY{p}{(}\PY{n}{i} \PY{o}{=} \PY{l+m+mi}{0}\PY{p}{;} \PY{n}{i} \PY{o}{<} \PY{n}{arg}\PY{o}{-}\PY{o}{>}\PY{n}{num\PYZus{}outputs}\PY{p}{;} \PY{o}{+}\PY{o}{+}\PY{n}{i}\PY{p}{)} \PY{p}{\PYZob{}}
	\PY{k}{if} \PY{p}{(}\PY{n}{rects}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{o}{-}\PY{o}{>}\PY{n}{x} \PY{o}{<} \PY{l+m+mi}{0} \PY{o}{|}\PY{o}{|} \PY{n}{rects}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{o}{-}\PY{o}{>}\PY{n}{y} \PY{o}{<} \PY{l+m+mi}{0}\PY{p}{)} \PY{p}{\PYZob{}}
		\PY{n}{ret} \PY{o}{-}\PY{n}{EINVAL}\PY{p}{;}
		\PY{k}{goto} \PY{n}{out}\PY{p}{;}
	\PY{p}{\PYZcb{}}
\PY{p}{\PYZcb{}}
\PY{c+c1}{// Clean up. }
\PY{n+nl}{out:}
	\PY{n}{kfree}\PY{p}{(}\PY{n}{rects}\PY{p}{)}\PY{p}{;}
	\PY{k}{return} \PY{n}{ret}\PY{p}{;}
\end{Verbatim}
